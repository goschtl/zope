
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Newbie Permissions Tutorial</title><meta name="description" content="Grok - now even cavemen can use Zope3" />
  <meta name="keywords" content="Grok, internet, zope, zope3, software, web apps, web applications, python" />
	<style type="text/css"><!-- @import url(/resources/grok.css); --></style>
</head>

<body>
<div class="header">
	
	<a href="http://grok.zope.org">
	<img src="/resources/grok-header.jpg" alt="GROK" /></a>
	<ul id="navigation">
        <li>
            <a href="/index.html" class="" title="Home">Home</a></li>
        <li>
            <a href="/about.html" class="" title="About">About</a></li>
        <li>
            <a href="/tutorial.html" class=""
               title="Tutorial">Tutorial</a></li>
        <li>
            <a href="/minitutorials/index.html" class=""
               title="How Tos">How Tos</a></li>
  </ul>
</div>


<div class="roundcont">
	
  <div class="roundtop">
    <img src="/resources/corner-topleft.jpg" alt="" width="45" height="45" class="corner" style="display: none" />
  </div>

  <div class="content">

          <h1 class="title">Newbie Permissions Tutorial</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Luis De la Parra; Uli Fouquet; Jan-Wijbrand Kolman</td></tr>
</tbody>
</table>
<p>Intended Audience:</p>
<blockquote>
<ul class="simple">
<li>Python Developers</li>
<li>Zope 2 Developers</li>
<li>Zope 3 Developers</li>
</ul>
</blockquote>
<div class="section">
<h2><a id="introduction" name="introduction">Introduction</a></h2>
<p>Zope3 and Grok come with authorization capabilities out of the box.  While a
vanilla Zope3 application protects all content by default and performs
authorization checks on the content objects themselves, Grok allows access to
everything unless you explicitly restrict it. The authorization checks here
are done based on the <tt class="docutils literal"><span class="pre">Views</span></tt> used to access (display/manipulate) the
content.</p>
</div>
<div class="section">
<h2><a id="setup" name="setup">Setup</a></h2>
<pre class="code-block python literal-block">
<span class="c">#contact.py</span>
<span class="k">from</span> <span class="nn">zope</span> <span class="k">import</span> <span class="n">component</span><span class="p">,</span> <span class="n">interface</span><span class="p">,</span> <span class="n">schema</span>
<span class="k">import</span> <span class="nn">grok</span>

<span class="k">class</span> <span class="nc">IContactInfo</span><span class="p">(</span><span class="n">interface</span><span class="o">.</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Interface/Schema for Contact Information &quot;&quot;&quot;</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u'First Name'</span><span class="p">)</span>
    <span class="n">last_name</span>  <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u'Last Name'</span><span class="p">)</span>
    <span class="n">email</span>      <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u'E-mail'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ContactInfo</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">IContactInfo</span><span class="p">)</span>

    <span class="n">first_name</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">last_name</span>  <span class="o">=</span> <span class="s">''</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s">''</span>

<span class="k">class</span> <span class="nc">ViewContact</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">View</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Display Contact Info, without e-mail.

    Anyone can use this view, even unauthenticated users
    over the internet
    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">contact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="k">return</span> <span class="s">'Contact: '</span> <span class="o">+</span> <span class="n">contact</span><span class="o">.</span><span class="n">first_name</span> <span class="o">+</span> <span class="n">contact</span><span class="o">.</span><span class="n">last_name</span>

</pre>
</div>
<div class="section">
<h2><a id="defining-permissions-and-restricting-access" name="defining-permissions-and-restricting-access">Defining Permissions and restricting access</a></h2>
<p>As all Views in Grok default to public access, anyone can use the
<tt class="docutils literal"><span class="pre">ViewContact</span></tt>-view defined above. If you want to restrict access to a view,
you have to explicitly protect it with a permission:</p>
<pre class="code-block python literal-block">
<span class="c"># Define Permissions. The grok.name can be any string, but it is strongly</span>
<span class="c"># recommended to make them unique by prefixing them with the application</span>
<span class="c"># name.</span>
<span class="k">class</span> <span class="nc">ViewContacts</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Permission</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">'mysite.ViewContacts'</span><span class="p">)</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'View Contacts'</span><span class="p">)</span> <span class="c"># optional</span>

<span class="k">class</span> <span class="nc">AddContacts</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Permission</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">'mysite.AddContacts'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EditContacts</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Permission</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">'mysite.EditContacts'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ViewContactComplete</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">View</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Display Contact Info, including email.

    Only users which have the permission 'mysite.ViewContacts'
    can use this view.
    &quot;&quot;&quot;</span><span class="s">&quot;</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="s">'mysite.ViewContacts'</span><span class="p">)</span>  <span class="c">#this is the security declaration</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">contact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="k">return</span> <span class="s">'Contact: </span><span class="si">%s%s%s</span><span class="s">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">contact</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                                    <span class="n">contact</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                                    <span class="n">contact</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

</pre>
<p><em>Note</em> The <tt class="docutils literal"><span class="pre">grok.Permission</span></tt> component base class was introduced <em>after</em> the
release 0.10. In earlier versions of Grok a permission was defined using a
module level directive, like so:</p>
<pre class="code-block python literal-block">
<span class="n">grok</span><span class="o">.</span><span class="n">define_permission</span><span class="p">(</span><span class="s">'mysite.ViewContacts'</span><span class="p">)</span>

</pre>
<p>If you are using <tt class="docutils literal"><span class="pre">grokproject</span></tt> this change currently does not affect your
installation. In this case use <tt class="docutils literal"><span class="pre">grok.define_permission</span></tt> as described above.</p>
</div>
<div class="section">
<h2><a id="granting-permissions" name="granting-permissions">Granting Permissions</a></h2>
<p>You can grant permissions to principals with a <tt class="docutils literal"><span class="pre">PermissionManager</span></tt>. For
example, if all registered users should have permission to view contact
details and to create new contacts, you could grant them the permissions when
the user account is created:</p>
<pre class="code-block python literal-block">
<span class="k">from</span> <span class="nn">zope.app.security.interfaces</span> <span class="k">import</span> <span class="n">IAuthentication</span>
<span class="k">from</span> <span class="nn">zope.app.securitypolicy.interfaces</span> <span class="k">import</span> <span class="n">IPrincipalPermissionManager</span>

<span class="k">def</span> <span class="nf">addUser</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">realname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a new user.

    create a new user and give it the authorizations,
    ``ViewContacts`` and ``EditContacts``. This example assumes
    you are using a Pluggable Authentication Utility (PAU) /
    PrincipalFolder, which you have to create and register when
    creating your Application.
    &quot;&quot;&quot;</span>

    <span class="n">pau</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">IAuthentication</span><span class="p">)</span>
    <span class="n">principals</span> <span class="o">=</span> <span class="n">pau</span><span class="p">[</span><span class="s">'principals'</span><span class="p">]</span>
    <span class="n">principals</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">InternalPrincipal</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">realname</span><span class="p">)</span>

    <span class="c"># grant the user permission to view and create contacts</span>
    <span class="c"># everywhere in the site</span>
    <span class="n">permission_man</span> <span class="o">=</span> <span class="n">IPrincipalPermissionManager</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">getSite</span><span class="p">())</span>

    <span class="c"># NOTE that you need a principal ID. If you are</span>
    <span class="c"># authenticating users with a PAU this is normally the user</span>
    <span class="c"># name prepended with the principals-folder prefix (and the</span>
    <span class="c"># PAU-prefix as well, if set)</span>
    <span class="n">permission_man</span><span class="o">.</span><span class="n">grantPermissionToPrincipal</span> <span class="p">(</span>
       <span class="s">'mysite.ViewContacts'</span><span class="p">,</span>
       <span class="n">principals</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">username</span><span class="p">)</span>
    <span class="n">permission_man</span><span class="o">.</span><span class="n">grantPermissionToPrincipal</span><span class="p">(</span>
       <span class="s">'mysite.AddContacts'</span><span class="p">,</span>
       <span class="n">principals</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">username</span><span class="p">)</span>

</pre>
<p>Permissions are granted for the context for which the PermissionManager is
created, and -- if not explicitly overridden -- all its children. The above
example grants <tt class="docutils literal"><span class="pre">View</span></tt> and <tt class="docutils literal"><span class="pre">Add</span></tt> permissions for the complete site, unless
a folder down in the hierarchy revokes the permission.</p>
<p>If you want users to be able to edit only their own <tt class="docutils literal"><span class="pre">ContactInfos</span></tt>, you have
to give them the <tt class="docutils literal"><span class="pre">Edit</span></tt> permission only within the context of the
<tt class="docutils literal"><span class="pre">ContactInfo</span></tt>-object itself</p>
<pre class="code-block python literal-block">
<span class="k">class</span> <span class="nc">AddContact</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">AddForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a contact.
    &quot;&quot;&quot;</span>

    <span class="c"># Only users with permission 'mysite.AddContacts' can use</span>
    <span class="c"># this.</span>
    <span class="c">#</span>
    <span class="c"># NOTE that if you don't protect this Form, anyone -- even</span>
    <span class="c"># anonymous/unauthenticated users -- could add ``Contacts``</span>
    <span class="c"># to the site.</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="s">'mysite.AddContacts'</span><span class="p">)</span>

    <span class="c">#automagically generate form fields</span>
    <span class="n">form_fields</span> <span class="o">=</span> <span class="n">grok</span><span class="o">.</span><span class="n">AutoFields</span><span class="p">(</span><span class="n">IContactInfo</span><span class="p">)</span>

    <span class="nd">&#64;grok</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="s">'Create'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c"># Create and add the ``ContactInfo`` to our context</span>
        <span class="c"># (normally a folder/container)</span>
        <span class="n">contact</span> <span class="o">=</span> <span class="n">ContactInfo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">applyData</span><span class="p">(</span><span class="n">contact</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">contact</span><span class="o">.</span><span class="n">first_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">contact</span>

        <span class="c"># Grant the current user the Edit permission, but only in</span>
        <span class="c"># the context of the newly created object.</span>
        <span class="n">permission_man</span> <span class="o">=</span> <span class="n">IPrincipalPermissionManager</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
        <span class="n">permission_man</span><span class="o">.</span><span class="n">grantPermissionToPrincipal</span><span class="p">(</span>
            <span class="s">'mysite.EditContacts'</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">principal</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">contact</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">EditContact</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">EditForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit a contact.
    &quot;&quot;&quot;</span>

    <span class="c">#only users with permission 'mysite.EditContacts' can use this</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="s">'mysite.EditContacts'</span><span class="p">)</span>

    <span class="n">form_fields</span> <span class="o">=</span> <span class="n">grok</span><span class="o">.</span><span class="n">AutoFields</span><span class="p">(</span><span class="n">IContactInfo</span><span class="p">)</span>

    <span class="nd">&#64;grok</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="s">'Save Changes'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">applyData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">))</span>

</pre>
</div>
<div class="section">
<h2><a id="checking-permissions" name="checking-permissions">Checking Permissions</a></h2>
<p>[FIXME How to check permissions in a page template and from python
code?  User Interfaces should not contain any links/actions which
users cannot access / for which users don't have authorizations]</p>
</div>
<div class="section">
<h2><a id="defining-roles" name="defining-roles">Defining Roles</a></h2>
<p>Permissions can be grouped together in <tt class="docutils literal"><span class="pre">Roles</span></tt>, which makes granting all the
permissions for a particular type of user much easier. Defining roles is
similar to defining permissions.</p>
<p>As an example, let's group all permissions in two roles: one for normal site
members, and one for administrators:</p>
<pre class="code-block python literal-block">
<span class="k">class</span> <span class="nc">MemberRole</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Role</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">'mysite.Member'</span><span class="p">)</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Contacts Member'</span><span class="p">)</span> <span class="c"># optional</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">permissions</span><span class="p">(</span>
        <span class="s">'mysite.ViewContacts'</span><span class="p">,</span>
        <span class="s">'mysite.AddContacts'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AdministratorRole</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Role</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">'mysite.Editor'</span><span class="p">)</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Contacts Administrator'</span><span class="p">)</span> <span class="c"># optional</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">permissions</span><span class="p">(</span>
        <span class="s">'mysite.ViewContacts'</span><span class="p">,</span>
        <span class="s">'mysite.AddContacts'</span><span class="p">,</span>
        <span class="s">'mysite.EditContacts'</span><span class="p">)</span>

</pre>
<p>Now, if the context here is the site/application, users with the administrator
role can edit all ContactInfos, regardless of who the creator is.</p>
<pre class="code-block python literal-block">
<span class="k">from</span> <span class="nn">zope.app.securitypolicy.interfaces</span> <span class="k">import</span> <span class="n">IPrincipalRoleManager</span>

<span class="n">role_man</span> <span class="o">=</span> <span class="n">IPrincipalRoleManager</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="n">role_man</span><span class="o">.</span><span class="n">assignRoleToPrincipal</span><span class="p">(</span><span class="s">'mysite.Administrator'</span><span class="p">,</span> <span class="n">principalID</span><span class="p">)</span>

</pre>
</div>

  </div>

  <div class="roundbottom">
     <img src="/resources/corner-bottomleft.jpg" alt="" width="45" height="45" class="corner" style="display: none" />
  </div>

</div>

<div class="footer">
	
	<table><tr><td>
	Grok cooks around the campfire of <br />
	<a href="http://wiki.zope.org/zope3/FrontPage"><img src="/resources/zopelogo.gif" alt="Zope" style="padding: 0.5em;" /></a>
	</td><td>
	 and roams free on the savannah of<br />
	<a href="http://www.python.org"><img src="/resources/python-logo.gif" style="padding: 0.5em;" alt="Python" /></a>
	</td></tr>
	</table>

	<p>Hosting provided by <a href="http://quintagroup.com/"><b>Quintagroup</b></a></p>
</div>

</body>
</html>
