
    <html>
      <head><title>Test coverage for mongopersist.zope.container</title>
      <style type="text/css">
        a {text-decoration: none; display: block; padding-right: 1em;}
        a:hover {background: #EFA;}
        hr {height: 1px; border: none; border-top: 1px solid gray;}
        .notcovered {background: #FCC;}
        .footer {margin: 2em; font-size: small; color: gray;}
      </style>
      </head>
      <body><h1>Test coverage for mongopersist.zope.container</h1>
      <table>
    
<tr><td><a href="mongopersist.html">mongopersist/</a></td> <td style="background: yellow">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 99% (1 of 695 uncovered)</td></tr>
<tr><td><a href="mongopersist.zope.html">&nbsp;&nbsp;&nbsp;&nbsp;zope/</a></td> <td style="background: green">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 100% (0 of 180 uncovered)</td></tr>
<tr><td><a href="mongopersist.zope.container.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;container.py</a></td> <td style="background: green">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 100% (0 of 179 uncovered)</td></tr>
</table><hr/>
<pre>
       <I><FONT COLOR="#B22222">##############################################################################
</FONT></I>       <I><FONT COLOR="#B22222">#
</FONT></I>       <I><FONT COLOR="#B22222"># Copyright (c) 2011 Zope Foundation and Contributors.
</FONT></I>       <I><FONT COLOR="#B22222"># All Rights Reserved.
</FONT></I>       <I><FONT COLOR="#B22222">#
</FONT></I>       <I><FONT COLOR="#B22222"># This software is subject to the provisions of the Zope Public License,
</FONT></I>       <I><FONT COLOR="#B22222"># Version 2.1 (ZPL).  A copy of the ZPL should accompany this distribution.
</FONT></I>       <I><FONT COLOR="#B22222"># THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY AND ALL EXPRESS OR IMPLIED
</FONT></I>       <I><FONT COLOR="#B22222"># WARRANTIES ARE DISCLAIMED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
</FONT></I>       <I><FONT COLOR="#B22222"># WARRANTIES OF TITLE, MERCHANTABILITY, AGAINST INFRINGEMENT, AND FITNESS
</FONT></I>       <I><FONT COLOR="#B22222"># FOR A PARTICULAR PURPOSE.
</FONT></I>       <I><FONT COLOR="#B22222">#
</FONT></I>       <I><FONT COLOR="#B22222">##############################################################################
</FONT></I>    1: <B><FONT COLOR="#BC8F8F">&quot;&quot;&quot;Mongo Persistence Zope Containers&quot;&quot;&quot;</FONT></B>
    1: <B><FONT COLOR="#A020F0">import</FONT></B> UserDict
    1: <B><FONT COLOR="#A020F0">import</FONT></B> persistent
    1: <B><FONT COLOR="#A020F0">import</FONT></B> pymongo.dbref
    1: <B><FONT COLOR="#A020F0">import</FONT></B> zope.component
    1: <B><FONT COLOR="#A020F0">from</FONT></B> rwproperty <B><FONT COLOR="#A020F0">import</FONT></B> getproperty, setproperty
    1: <B><FONT COLOR="#A020F0">from</FONT></B> zope.container <B><FONT COLOR="#A020F0">import</FONT></B> contained, sample
       
    1: <B><FONT COLOR="#A020F0">from</FONT></B> mongopersist <B><FONT COLOR="#A020F0">import</FONT></B> interfaces, serialize
       
       
    2: <B><FONT COLOR="#A020F0">class</FONT></B> MongoContained(contained.Contained):
       
    1:     @getproperty
           <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__name__</FONT></B>(self):
    5:         <B><FONT COLOR="#A020F0">return</FONT></B> getattr(self, <B><FONT COLOR="#BC8F8F">'_v_key'</FONT></B>, None)
    1:     @setproperty
           <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__name__</FONT></B>(self, value):
    1:         setattr(self, <B><FONT COLOR="#BC8F8F">'_v_key'</FONT></B>, value)
       
    1:     @getproperty
           <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__parent__</FONT></B>(self):
    5:         <B><FONT COLOR="#A020F0">return</FONT></B> getattr(self, <B><FONT COLOR="#BC8F8F">'_v_parent'</FONT></B>, None)
    1:     @setproperty
           <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__parent__</FONT></B>(self, value):
    1:         setattr(self, <B><FONT COLOR="#BC8F8F">'_v_parent'</FONT></B>, value)
       
       
    2: <B><FONT COLOR="#A020F0">class</FONT></B> SimpleMongoContainer(sample.SampleContainer, persistent.Persistent):
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__getstate__</FONT></B>(self):
    5:         state = super(SimpleMongoContainer, self).__getstate__()
    5:         state[<B><FONT COLOR="#BC8F8F">'data'</FONT></B>] = state.pop(<B><FONT COLOR="#BC8F8F">'_SampleContainer__data'</FONT></B>)
    5:         <B><FONT COLOR="#A020F0">return</FONT></B> state
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__setstate__</FONT></B>(self, state):
    4:         state[<B><FONT COLOR="#BC8F8F">'_SampleContainer__data'</FONT></B>] = state.pop(<B><FONT COLOR="#BC8F8F">'data'</FONT></B>, {})
    4:         super(SimpleMongoContainer, self).__setstate__(state)
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__getitem__</FONT></B>(self, key):
   13:         obj = super(SimpleMongoContainer, self).__getitem__(key)
   12:         obj._v_key = key
   12:         obj._v_parent = self
   12:         <B><FONT COLOR="#A020F0">return</FONT></B> obj
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">get</FONT></B>(self, key, default=None):
               <B><FONT COLOR="#BC8F8F">'''See interface `IReadContainer`'''</FONT></B>
    3:         obj = super(SimpleMongoContainer, self).get(key, default)
    3:         <B><FONT COLOR="#A020F0">if</FONT></B> obj <B><FONT COLOR="#A020F0">is</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> default:
    1:             obj._v_key = key
    1:             obj._v_parent = self
    3:         <B><FONT COLOR="#A020F0">return</FONT></B> obj
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">items</FONT></B>(self):
    2:         items = super(SimpleMongoContainer, self).items()
    4:         <B><FONT COLOR="#A020F0">for</FONT></B> key, obj <B><FONT COLOR="#A020F0">in</FONT></B> items:
    2:             obj._v_key = key
    2:             obj._v_parent = self
    2:         <B><FONT COLOR="#A020F0">return</FONT></B> items
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">values</FONT></B>(self):
    2:         <B><FONT COLOR="#A020F0">return</FONT></B> [v <B><FONT COLOR="#A020F0">for</FONT></B> k, v <B><FONT COLOR="#A020F0">in</FONT></B> self.items()]
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__setitem__</FONT></B>(self, key, object):
    2:         super(SimpleMongoContainer, self).__setitem__(key, object)
    2:         self._p_changed = True
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__delitem__</FONT></B>(self, key):
    1:         super(SimpleMongoContainer, self).__delitem__(key)
    1:         self._p_changed = True
       
    2: <B><FONT COLOR="#A020F0">class</FONT></B> MongoContainer(contained.Contained,
    1:                      persistent.Persistent,
    1:                      UserDict.DictMixin):
    1:     _m_database = None
    1:     _m_collection = None
    1:     _m_mapping_key = <B><FONT COLOR="#BC8F8F">'key'</FONT></B>
    1:     _m_parent_key = <B><FONT COLOR="#BC8F8F">'parent'</FONT></B>
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__init__</FONT></B>(self, collection=None, database=None,
    1:                  mapping_key=None, parent_key=None):
   10:         <B><FONT COLOR="#A020F0">if</FONT></B> collection:
   10:             self._m_collection = collection
   10:         <B><FONT COLOR="#A020F0">if</FONT></B> database:
    1:             self._m_database = database
   10:         <B><FONT COLOR="#A020F0">if</FONT></B> mapping_key <B><FONT COLOR="#A020F0">is</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> None:
    1:             self._m_mapping_key = mapping_key
   10:         <B><FONT COLOR="#A020F0">if</FONT></B> parent_key <B><FONT COLOR="#A020F0">is</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> None:
    1:             self._m_parent_key = parent_key
       
    1:     @property
           <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">_added</FONT></B>(self):
   48:         ann = self._m_jar.annotations.setdefault(self._p_oid <B><FONT COLOR="#A020F0">or</FONT></B> id(self), {})
   48:         <B><FONT COLOR="#A020F0">return</FONT></B> ann.setdefault(<B><FONT COLOR="#BC8F8F">'added'</FONT></B>, {})
       
    1:     @property
           <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">_deleted</FONT></B>(self):
   46:         ann = self._m_jar.annotations.setdefault(self._p_oid <B><FONT COLOR="#A020F0">or</FONT></B> id(self), {})
   46:         <B><FONT COLOR="#A020F0">return</FONT></B> ann.setdefault(<B><FONT COLOR="#BC8F8F">'deleted'</FONT></B>, {})
       
    1:     @property
           <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">_m_jar</FONT></B>(self):
               <I><FONT COLOR="#B22222"># If the container is in a Mongo storage hierarchy, then getting the
</FONT></I>               <I><FONT COLOR="#B22222"># datamanager is easy, otherwise we do an adapter lookup.
</FONT></I>  228:         <B><FONT COLOR="#A020F0">if</FONT></B> interfaces.IMongoDataManager.providedBy(self._p_jar):
  208:             <B><FONT COLOR="#A020F0">return</FONT></B> self._p_jar
               <B><FONT COLOR="#A020F0">else</FONT></B>:
   20:             provider = zope.component.getUtility(
   20:                 interfaces.IMongoDataManagerProvider)
   19:             <B><FONT COLOR="#A020F0">return</FONT></B> provider.get()
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">get_collection</FONT></B>(self):
   27:         db_name = self._m_database <B><FONT COLOR="#A020F0">or</FONT></B> self._m_jar.default_database
   27:         <B><FONT COLOR="#A020F0">return</FONT></B> self._m_jar._conn[db_name][self._m_collection]
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">_m_get_parent_key_value</FONT></B>(self):
   48:         <B><FONT COLOR="#A020F0">if</FONT></B> getattr(self, <B><FONT COLOR="#BC8F8F">'_p_jar'</FONT></B>, None) <B><FONT COLOR="#A020F0">is</FONT></B> None:
    1:             <B><FONT COLOR="#A020F0">raise</FONT></B> ValueError(<B><FONT COLOR="#BC8F8F">'_p_jar not found.'</FONT></B>)
   47:         <B><FONT COLOR="#A020F0">if</FONT></B> interfaces.IMongoDataManager.providedBy(self._p_jar):
   42:             <B><FONT COLOR="#A020F0">return</FONT></B> self
               <B><FONT COLOR="#A020F0">else</FONT></B>:
   50:             <B><FONT COLOR="#A020F0">return</FONT></B> <B><FONT COLOR="#BC8F8F">'zodb-'</FONT></B>+<B><FONT COLOR="#BC8F8F">''</FONT></B>.join(<B><FONT COLOR="#BC8F8F">&quot;%02x&quot;</FONT></B> % ord(x) <B><FONT COLOR="#A020F0">for</FONT></B> x <B><FONT COLOR="#A020F0">in</FONT></B> self._p_oid).strip()
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">_m_get_items_filter</FONT></B>(self):
   28:         filter = {}
               <I><FONT COLOR="#B22222"># Make sure that we only look through objects that have the mapping
</FONT></I>               <I><FONT COLOR="#B22222"># key. Objects not having the mapping key cannot be part of the
</FONT></I>               <I><FONT COLOR="#B22222"># collection.
</FONT></I>   28:         <B><FONT COLOR="#A020F0">if</FONT></B> self._m_mapping_key <B><FONT COLOR="#A020F0">is</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> None:
   28:             filter[self._m_mapping_key] = {<B><FONT COLOR="#BC8F8F">'$exists'</FONT></B>: True}
   28:         <B><FONT COLOR="#A020F0">if</FONT></B> self._m_parent_key <B><FONT COLOR="#A020F0">is</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> None:
   27:             gs = self._m_jar._writer.get_state
   26:             filter[self._m_parent_key] = gs(self._m_get_parent_key_value())
   27:         <B><FONT COLOR="#A020F0">return</FONT></B> filter
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__getitem__</FONT></B>(self, key):
   12:         <B><FONT COLOR="#A020F0">if</FONT></B> key <B><FONT COLOR="#A020F0">in</FONT></B> self._added:
    4:             <B><FONT COLOR="#A020F0">return</FONT></B> self._added[key]
    8:         <B><FONT COLOR="#A020F0">if</FONT></B> key <B><FONT COLOR="#A020F0">in</FONT></B> self._deleted:
    1:             <B><FONT COLOR="#A020F0">raise</FONT></B> KeyError(key)
    7:         filter = self._m_get_items_filter()
    7:         filter[self._m_mapping_key] = key
    7:         doc = self.get_collection().find_one(filter, fields=())
    7:         <B><FONT COLOR="#A020F0">if</FONT></B> doc <B><FONT COLOR="#A020F0">is</FONT></B> None:
    1:             <B><FONT COLOR="#A020F0">raise</FONT></B> KeyError(key)
    6:         dbref = pymongo.dbref.DBRef(
    6:             self._m_collection, doc[<B><FONT COLOR="#BC8F8F">'_id'</FONT></B>],
    6:             self._m_database <B><FONT COLOR="#A020F0">or</FONT></B> self._m_jar.default_database)
    6:         obj = self._m_jar._reader.get_ghost(dbref)
    6:         obj._v_key = key
    6:         obj._v_parent = self
    6:         <B><FONT COLOR="#A020F0">return</FONT></B> obj
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__setitem__</FONT></B>(self, key, value):
               <I><FONT COLOR="#B22222"># This call by iteself caues the state to change _p_changed to True.
</FONT></I>   19:         setattr(value, self._m_mapping_key, key)
   19:         <B><FONT COLOR="#A020F0">if</FONT></B> self._m_parent_key <B><FONT COLOR="#A020F0">is</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> None:
   19:             setattr(value, self._m_parent_key, self._m_get_parent_key_value())
   19:         self._m_jar.register(value)
               <I><FONT COLOR="#B22222"># Temporarily store the added object, so it is immediately available
</FONT></I>               <I><FONT COLOR="#B22222"># via the API.
</FONT></I>   19:         value._v_key = key
   19:         value._v_parent = self
   19:         self._added[key] = value
   19:         self._deleted.pop(key, None)
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">__delitem__</FONT></B>(self, key):
               <I><FONT COLOR="#B22222"># Deleting the object from the database is not our job. We simply
</FONT></I>               <I><FONT COLOR="#B22222"># remove it from the dictionary.
</FONT></I>    1:         value = self[key]
    1:         <B><FONT COLOR="#A020F0">if</FONT></B> self._m_mapping_key <B><FONT COLOR="#A020F0">is</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> None:
    1:             delattr(value, self._m_mapping_key)
    1:         <B><FONT COLOR="#A020F0">if</FONT></B> self._m_parent_key <B><FONT COLOR="#A020F0">is</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> None:
    1:             delattr(value, self._m_parent_key)
    1:         self._deleted[key] = value
    1:         self._added.pop(key, None)
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">keys</FONT></B>(self):
   13:         filter = self._m_get_items_filter()
   12:         filter[self._m_mapping_key] = {<B><FONT COLOR="#BC8F8F">'$ne'</FONT></B>: None}
               keys = [
   12:             doc[self._m_mapping_key]
   12:             <B><FONT COLOR="#A020F0">for</FONT></B> doc <B><FONT COLOR="#A020F0">in</FONT></B> self.get_collection().find(filter)
   18:             <B><FONT COLOR="#A020F0">if</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> doc[self._m_mapping_key] <B><FONT COLOR="#A020F0">in</FONT></B> self._deleted]
   12:         keys += self._added.keys()
   12:         <B><FONT COLOR="#A020F0">return</FONT></B> keys
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">raw_find</FONT></B>(self, spec=None, *args, **kwargs):
    3:         <B><FONT COLOR="#A020F0">if</FONT></B> spec <B><FONT COLOR="#A020F0">is</FONT></B> None:
    1:             spec  = {}
    3:         spec.update(self._m_get_items_filter())
    3:         <B><FONT COLOR="#A020F0">return</FONT></B> self.get_collection().find(spec, *args, **kwargs)
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">find</FONT></B>(self, spec=None, fields=None, *args, **kwargs):
               <I><FONT COLOR="#B22222"># If fields were not specified, we only request the oid and the key.
</FONT></I>    2:         fields = tuple(fields <B><FONT COLOR="#A020F0">or</FONT></B> ())
    2:         fields += (self._m_mapping_key,)
    2:         result = self.raw_find(spec, fields, *args, **kwargs)
   10:         <B><FONT COLOR="#A020F0">for</FONT></B> doc <B><FONT COLOR="#A020F0">in</FONT></B> result:
    8:             dbref = pymongo.dbref.DBRef(
    8:                 self._m_collection, doc[<B><FONT COLOR="#BC8F8F">'_id'</FONT></B>],
    8:                 self._m_database <B><FONT COLOR="#A020F0">or</FONT></B> self._m_jar.default_database)
    8:             obj = self._m_jar._reader.get_ghost(dbref)
    8:             obj._v_key = doc[self._m_mapping_key]
    8:             obj._v_parent = self
    8:             <B><FONT COLOR="#A020F0">yield</FONT></B> obj
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">raw_find_one</FONT></B>(self, spec_or_id=None, *args, **kwargs):
    5:         <B><FONT COLOR="#A020F0">if</FONT></B> spec_or_id <B><FONT COLOR="#A020F0">is</FONT></B> None:
    1:             spec_or_id  = {}
    5:         <B><FONT COLOR="#A020F0">if</FONT></B> <B><FONT COLOR="#A020F0">not</FONT></B> isinstance(spec_or_id, dict):
    1:             spec_or_id = {<B><FONT COLOR="#BC8F8F">'_id'</FONT></B>: spec_or_id}
    5:         spec_or_id.update(self._m_get_items_filter())
    5:         <B><FONT COLOR="#A020F0">return</FONT></B> self.get_collection().find_one(spec_or_id, *args, **kwargs)
       
    1:     <B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">find_one</FONT></B>(self, spec_or_id=None, fields=None, *args, **kwargs):
               <I><FONT COLOR="#B22222"># If fields were not specified, we only request the oid and the key.
</FONT></I>    4:         fields = tuple(fields <B><FONT COLOR="#A020F0">or</FONT></B> ())
    4:         fields += (self._m_mapping_key,)
    4:         doc = self.raw_find_one(spec_or_id, fields, *args, **kwargs)
    4:         <B><FONT COLOR="#A020F0">if</FONT></B> doc <B><FONT COLOR="#A020F0">is</FONT></B> None:
    1:             <B><FONT COLOR="#A020F0">return</FONT></B> None
    3:         dbref = pymongo.dbref.DBRef(
    3:             self._m_collection, doc[<B><FONT COLOR="#BC8F8F">'_id'</FONT></B>],
    3:             self._m_database <B><FONT COLOR="#A020F0">or</FONT></B> self._m_jar.default_database)
    3:         obj = self._m_jar._reader.get_ghost(dbref)
    3:         obj._v_key = doc[self._m_mapping_key]
    3:         obj._v_parent = self
    3:         <B><FONT COLOR="#A020F0">return</FONT></B> obj
       
    2: <B><FONT COLOR="#A020F0">class</FONT></B> AllItemsMongoContainer(MongoContainer):
    1:     _m_parent_key = None
       
       
    2: <B><FONT COLOR="#A020F0">class</FONT></B> SubDocumentMongoContainer(MongoContained, MongoContainer):
    1:     _p_mongo_sub_object = True
</pre>

      <div class="footer">
      Generated for revision 5108:5114M on 2011-11-04 17:02:17.574731Z
      </div>
    </body>
    </html>
