===============================
Connecting to Javascript Events
===============================

The ``jsevent`` module of this package implements a mechanism to connect a
Javascript script to an event of a DOM element. So let's have a look at how
this works.

  >>> from z3c.formjs import interfaces, jsevent

To implement this functionality, we need to model three components: events,
DOM elements (selector), and the script (handler). We will also need a manager
to keep track of all the mappings. This is indeed somewhat similar to the Zope
3 event model, though we do not need DOM elements to connect the events there.


Subscription Manager
--------------------

So first we need to create a subscription manager in which to collect the
subscriptions:

  >>> manager = jsevent.JSSubscriptions()

Initially, we have no registered events:

  >>> list(manager)
  []

We now want to subscribe to the "click" event of a DOM element with the id
"message". When the event occurs, we would like to display a simple "Hello
World" message.

The events are available in all capital letters, for example:

  >>> jsevent.CLICK
  <JSEvent "click">

The DOM element is selected using a selector, in our case an id selector:

  >>> selector = jsevent.IdSelector('message')
  >>> selector
  <IdSelector "message">

The handler of the event is a callable accepting the event, selector and the
request:

  >>> def showHelloWorldAlert(event, selector, request):
  ...     return u'alert("Hello World!")'

We have finally all the pieces together to subscribe the event:

  >>> manager.subscribe(jsevent.CLICK, selector, showHelloWorldAlert)

So now we can see the subscription:

  >>> list(manager)
  [<JSSubscription event=<JSEvent "click">,
                   selector=<IdSelector "message">,
                   handler=<function showHelloWorldAlert at ...>>]

So now, how does this get rendered into Javascript code? Since this package
strictly separates definition from rendering, a renderer will be responsible
to produce the output.


Renderers
---------

So let's define some renderers for the various components. We start with the
selector. Let's say that the javascript framework supports CSS selectors, then
the renderer is simple:

  >>> import zope.component
  >>> import zope.interface
  >>> from zope.publisher.interfaces.browser import IBrowserRequest

  >>> class IdSelectorRenderer(object):
  ...     zope.interface.implements(interfaces.IRenderer)
  ...     zope.component.adapts(interfaces.IIdSelector, IBrowserRequest)
  ...
  ...     def __init__(self, selector, request):
  ...         self.selector = selector
  ...
  ...     def update(self):
  ...         pass
  ...
  ...     def render(self):
  ...         return u'#' + self.selector.id

  >>> zope.component.provideAdapter(IdSelectorRenderer)

Of course, like all view components, the renderer supports the update/render
pattern. We can now render the selector:

  >>> from zope.publisher.browser import TestRequest
  >>> request = TestRequest()

  >>> renderer = zope.component.getMultiAdapter(
  ...     (selector, request), interfaces.IRenderer)
  >>> renderer.update()
  >>> renderer.render()
  u'#message'

Next we need a renderer for the subscription. Let's assume we can bind the
subscription as follows: ``$(<selector>).bind("<event>", <script>)``

  >>> class SubscriptionRenderer(object):
  ...     zope.interface.implements(interfaces.IRenderer)
  ...     zope.component.adapts(interfaces.IJSSubscription, IBrowserRequest)
  ...
  ...     def __init__(self, subscription, request):
  ...         self.subscription = subscription
  ...         self.request = request
  ...
  ...     def update(self):
  ...         self.selectorRenderer = zope.component.getMultiAdapter(
  ...             (self.subscription.selector, request), interfaces.IRenderer)
  ...         self.selectorRenderer.update()
  ...
  ...     def render(self):
  ...         return u'$("%s").bind("%s", function(){%s});' %(
  ...             self.selectorRenderer.render(),
  ...             self.subscription.event.name,
  ...             self.subscription.handler(
  ...                 self.subscription.event,
  ...                 self.subscription.selector,
  ...                 self.request) )

  >>> zope.component.provideAdapter(SubscriptionRenderer)

Rendering the subscription then return this:

  >>> renderer = zope.component.getMultiAdapter(
  ...     (list(manager)[0], request), interfaces.IRenderer)
  >>> renderer.update()
  >>> print renderer.render()
  $("#message").bind("click", function(){alert("Hello World!")});

And now to the grant finale. We create a renderer for the subscription manager.

  >>> class ManagerRenderer(object):
  ...     zope.interface.implements(interfaces.IRenderer)
  ...     zope.component.adapts(interfaces.IJSSubscriptions, IBrowserRequest)
  ...
  ...     def __init__(self, manager, request):
  ...         self.manager = manager
  ...
  ...     def update(self):
  ...         self.renderers = []
  ...         for subscription in self.manager:
  ...             renderer = zope.component.getMultiAdapter(
  ...                 (subscription, request), interfaces.IRenderer)
  ...             renderer.update()
  ...             self.renderers.append(renderer)
  ...
  ...     def render(self):
  ...         return '$(document).ready(function(){\n  %s\n})' %(
  ...             '\n  '.join([r.render() for r in self.renderers]) )

  >>> zope.component.provideAdapter(ManagerRenderer)

Let's now render the entire manager.

  >>> renderer = zope.component.getMultiAdapter(
  ...     (manager, request), interfaces.IRenderer)
  >>> renderer.update()
  >>> print renderer.render()
  $(document).ready(function(){
    $("#message").bind("click", function(){alert("Hello World!")});
  })


Javascript Viewlet
------------------

Putting in the Javascript by hand in every layout is a bit lame. Instead we
can just register a viewlet for the JS viewlet manager that renders the
subscriptions if a manager is found.

To use the viewlet we need a view that provides a subscription manager:

  >>> class View(object):
  ...     zope.interface.implements(interfaces.IHaveJSSubscriptions)
  ...     jsSubscriptions = manager

We can now initialize, update, and finally render the viewlet:

  >>> viewlet = jsevent.JSSubscriptionsViewlet(
  ...     object(), request, View(), object())
  >>> viewlet.update()
  >>> print viewlet.render()
  <script type="text/javascript">
  $(document).ready(function(){
    $("#message").bind("click", function(){alert("Hello World!")});
  })
  </script>


Available Events
----------------

This package maps all of the available JavaScript events. Here is the complete
list:

  >>> jsevent.CLICK
  <JSEvent "click">
  >>> jsevent.DBLCLICK
  <JSEvent "dblclick">
  >>> jsevent.CHANGE
  <JSEvent "change">
  >>> jsevent.LOAD
  <JSEvent "load">
  >>> jsevent.BLUR
  <JSEvent "blur">
  >>> jsevent.FOCUS
  <JSEvent "focus">
  >>> jsevent.KEYDOWN
  <JSEvent "keydown">
  >>> jsevent.KEYUP
  <JSEvent "keyup">
  >>> jsevent.MOUSEDOWN
  <JSEvent "mousedown">
  >>> jsevent.MOUSEMOVE
  <JSEvent "mousemove">
  >>> jsevent.MOUSEOUT
  <JSEvent "mouseout">
  >>> jsevent.MOUSEOVER
  <JSEvent "mouseover">
  >>> jsevent.MOUSEUP
  <JSEvent "mouseup">
  >>> jsevent.RESIZE
  <JSEvent "resize">
  >>> jsevent.SELECT
  <JSEvent "select">
  >>> jsevent.SUBMIT
  <JSEvent "submit">

These are also provided as utilities so they can be looked up by name.

  >>> import zope.component
  >>> zope.component.provideUtility(jsevent.CLICK, name='click')

Of course, we can now just look up the utility:

  >>> zope.component.getUtility(interfaces.IJSEvent, 'click')
  <JSEvent "click">
