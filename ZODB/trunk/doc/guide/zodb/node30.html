<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>3.6 Sample Application: chatter.py</title>
<META NAME="description" CONTENT="3.6 Sample Application: chatter.py">
<META NAME="keywords" CONTENT="zodb">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<meta http-equiv="Content-Type" content="text/html; charset=">
<link rel="STYLESHEET" href="zodb.css">
<link rel="first" href="zodb.html">
<link rel="contents" href="contents.html" title="Contents">

<LINK REL="previous" HREF="node29.html">
<LINK REL="up" href="zeo.html">
<LINK REL="next" HREF="node31.html">
</head>
<body>
<DIV CLASS="navigation">
<table align="center" width="100%" cellpadding="0" cellspacing="2">
<tr>
<td><A HREF="node29.html"><img src="/python/writing/icons/previous.gif"
  border="0" height="32"
  alt="Previous Page" width="32"></A></td>
<td><A href="zeo.html"><img src="/python/writing/icons/up.gif"
  border="0" height="32"
  alt="Up One Level" width="32"></A></td>
<td><A HREF="node31.html"><img src="/python/writing/icons/next.gif"
  border="0" height="32"
  alt="Next Page" width="32"></A></td>
<td align="center" width="100%">ZODB/ZEO Programming Guide</td>
<td><A href="contents.html"><img src="/python/writing/icons/contents.gif"
  border="0" height="32"
  alt="Contents" width="32"></A></td>
<td><img src="/python/writing/icons/blank.gif"
  border="0" height="32"
  alt="" width="32"></td>
<td><img src="/python/writing/icons/blank.gif"
  border="0" height="32"
  alt="" width="32"></td>
</tr></table>
<b class="navlabel">Previous:</b> <a class="sectref" HREF="node29.html">3.5 ZEO Programming Notes</A>
<b class="navlabel">Up:</b> <a class="sectref" href="zeo.html">3 ZEO</A>
<b class="navlabel">Next:</b> <a class="sectref" HREF="node31.html">4 Transactions and Versioning</A>
<br><hr>
</DIV>
<!--End of Navigation Panel-->

<H2><A NAME="SECTION000460000000000000000">
3.6 Sample Application: chatter.py</A>
</H2>

<P>
For an example application, we'll build a little chat application.
What's interesting is that none of the application's code deals with
network programming at all; instead, an object will hold chat
messages, and be magically shared between all the clients through ZEO.
I won't present the complete script here; it's included in my ZODB
distribution, and you can download it from
<a class="url" href="http://www.amk.ca/zodb/demos/">http://www.amk.ca/zodb/demos/</a>.  Only the interesting portions of
the code will be covered here.

<P>
The basic data structure is the <tt class="class">ChatSession</tt> object,
which provides an <tt class="method">add_message()</tt> method that adds a
message, and a <tt class="method">new_messages()</tt> method that returns a list
of new messages that have accumulated since the last call to
<tt class="method">new_messages()</tt>.  Internally, <tt class="class">ChatSession</tt>
maintains a B-tree that uses the time as the key, and stores the
message as the corresponding value.

<P>
The constructor for <tt class="class">ChatSession</tt> is pretty simple; it simply
creates an attribute containing a B-tree:

<P>
<dl><dd><pre class="verbatim">
class ChatSession(Persistent):
    def __init__(self, name):
        self.name = name
        # Internal attribute: _messages holds all the chat messages.        
        self._messages = BTree.BTree()
</pre></dl>

<P>
<tt class="method">add_message()</tt> has to add a message to the
<code>_messages</code> B-tree.  A complication is that it's possible
that some other client is trying to add a message at the same time;
when this happens, the client that commits first wins, and the second
client will get a <tt class="exception">ConflictError</tt> exception when it tries to
commit.  For this application, <tt class="exception">ConflictError</tt> isn't serious
but simply means that the operation has to be retried; other
applications might treat it as a fatal error.  The code uses
<code>try...except...else</code> inside a <code>while</code> loop,
breaking out of the loop when the commit works without raising an
exception.

<P>
<dl><dd><pre class="verbatim">
    def add_message(self, message):
        """Add a message to the channel.
        message -- text of the message to be added
        """

        while 1:
            try:
                now = time.time()
                self._messages[now] = message
                get_transaction().commit()
            except ConflictError:
                # Conflict occurred; this process should pause and
                # wait for a little bit, then try again.
                time.sleep(.2)
                pass
            else:
                # No ConflictError exception raised, so break
                # out of the enclosing while loop.
                break
        # end while
</pre></dl>

<P>
<tt class="method">new_messages()</tt> introduces the use of <i>volatile</i>
attributes.  Attributes of a persistent object that begin with
<code>_v_</code> are considered volatile and are never stored in the
database.  <tt class="method">new_messages()</tt> needs to store the last time
the method was called, but if the time was stored as a regular
attribute, its value would be committed to the database and shared
with all the other clients.  <tt class="method">new_messages()</tt> would then
return the new messages accumulated since any other client called
<tt class="method">new_messages()</tt>, which isn't what we want.

<P>
<dl><dd><pre class="verbatim">
    def new_messages(self):
        "Return new messages."

        # self._v_last_time is the time of the most recent message
        # returned to the user of this class. 
        if not hasattr(self, '_v_last_time'):
            self._v_last_time = 0

        new = []
        T = self._v_last_time

        for T2, message in self._messages.items():
            if T2 &gt; T:
                new.append(message)
                self._v_last_time = T2

        return new
</pre></dl>

<P>
This application is interesting because it uses ZEO to easily share a
data structure; ZEO and ZODB are being used for their networking
ability, not primarily for their data storage ability.  I can foresee
many interesting applications using ZEO in this way:

<P>

<UL>
<LI>With a Tkinter front-end, and a cleverer, more scalable data
  structure, you could build a shared whiteboard using the same
  technique.

<P>
</LI>
<LI>A shared chessboard object would make writing a networked chess
  game easy.  

<P>
</LI>
<LI>You could create a Python class containing a CD's title and
  track information.  To make a CD database, a read-only ZEO server
  could be opened to the world, or an HTTP or XML-RPC interface could
  be written on top of the ZODB.

<P>
</LI>
<LI>A program like Quicken could use a ZODB on the local disk to
  store its data.  This avoids the need to write and maintain
  specialized I/O code that reads in your objects and writes them out;
  instead you can concentrate on the problem domain, writing objects
  that represent cheques, stock portfolios, or whatever.

<P>
</LI>
</UL>

<P>

<DIV CLASS="navigation">
<p><hr>
<table align="center" width="100%" cellpadding="0" cellspacing="2">
<tr>
<td><A HREF="node29.html"><img src="/python/writing/icons/previous.gif"
  border="0" height="32"
  alt="Previous Page" width="32"></A></td>
<td><A href="zeo.html"><img src="/python/writing/icons/up.gif"
  border="0" height="32"
  alt="Up One Level" width="32"></A></td>
<td><A HREF="node31.html"><img src="/python/writing/icons/next.gif"
  border="0" height="32"
  alt="Next Page" width="32"></A></td>
<td align="center" width="100%">ZODB/ZEO Programming Guide</td>
<td><A href="contents.html"><img src="/python/writing/icons/contents.gif"
  border="0" height="32"
  alt="Contents" width="32"></A></td>
<td><img src="/python/writing/icons/blank.gif"
  border="0" height="32"
  alt="" width="32"></td>
<td><img src="/python/writing/icons/blank.gif"
  border="0" height="32"
  alt="" width="32"></td>
</tr></table>
<b class="navlabel">Previous:</b> <a class="sectref" HREF="node29.html">3.5 ZEO Programming Notes</A>
<b class="navlabel">Up:</b> <a class="sectref" href="zeo.html">3 ZEO</A>
<b class="navlabel">Next:</b> <a class="sectref" HREF="node31.html">4 Transactions and Versioning</A>
<hr>
<span class="release-info">Release 0.03, documentation updated on February 8, 2002.</span>
</DIV>
<!--End of Navigation Panel-->

</BODY>
</HTML>
