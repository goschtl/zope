Migrating from Zope 3.4 to Zope Framework 3.5
=============================================

This document covers major changes from the Zope 3.4 release to the
Zope Framework 3.5 release that can lead to
backward-incompatibilities.

.. contents::

Introduction
------------

The Zope Framework 3.5 release is the first release of the Zope
Framework. The Zope Framework really is just a collection of libraries
managed together by the Zope developers. We typically treat each
library independently, so you would like to look at the CHANGES.txt in
each library for updates. Here we note larger changes, especially ones
that affect multiple libraries.

The Zope Framework cannot be installed directly except as individual
libraries (such as ``zope.component``). To install it you typically
would install a framework or application that makes use of these
libraries. The Zope project itself manages Zope 3, Zope 2, or Grok.

The 3.5 release of the Zope Framework contains a number of
refactorings that are aimed to clean up dependencies between pieces of
code. Many packages in ``zope.app`` have had their code moved to
existing or newly created packages in the ``zope`` namespace. These
new packages do generally not contain user interface code (typically
what's in ``.browser``), and have much clearer dependency
relationships as a result.

Backwards compatibility imports have been left in place so that your
existing code should still work. In some cases you will have to
explicitly add dependencies to a ``zope.app.`` to your code, as due to
the cleanup they might not come in automatically anymore due to
indirect dependencies; if you see an import error this is probably the
case.

We recommend you update your existing code to import from the new
packages if possible. We list major changes below. We are also working
on an extension to the Zope testrunner that can indicate indirect
imports, as well as a tool to upgrade existing ZODBs to make use of
new import locations.

zope.app.keyreference -> zope.keyreference
------------------------------------------

This package was renamed to ``zope.keyreference`` and all its
functionality was moved to the new one. The new package contains a
little workaround for making old persistent keyrerefences loadable
without ``zope.app.keyreference`` installed, so the latter one is not
needed at all anymore. Still review your code for any imports coming
from ``zope.app.keyreference`` and modify it to use
``zope.keyreference`` instead.

zope.app.intid -> zope.intid
-----------------------------

The non-UI functionality of these packages was moved to ``zope.intid``
with backwards compatibility imports left in place. Review your
imports from ``zope.app.intid`` to see whether they cannot come
directly from ``zope.intid`` instead.

zope.app.catalog -> zope.catalog
--------------------------------

The non-UI functionality of these packages was moved to
``zope.catalog``. Review your imports from ``zope.app.catalog`` to see
whether they cannot come directly from ``zope.catalog`` instead.

zope.app.container -> zope.container
------------------------------------

The non-UI functionality of these packages was moved to
``zope.container``. Review your imports from ``zope.app.container`` to
see whether they cannot come directly from ``zope.container`` instead.

In addition, the exceptions used by ``zope.container`` were changed,
so if your code catches them, you need to review it:

* The ``DuplicationError`` in ``setitem`` was changed to ``KeyError``.

* The ``UserError`` in ``NameChooser`` was changed to ``ValueError``.

zope.app.component -> zope.security, zope.site
----------------------------------------------

The implementation of the ``<class>`` ZCML directive moved from this
package to ``zope.security``. Packages that relied on
``zope.app.component`` to obtain this directive should declare a
direct dependency on ``zope.security``, and it may be possible to lose
the dependency on ``zope.app.component`` altogether.

Non-UI site related functionality has been moved to the ``zope.site``
package. with backwards compatibility imports left in place. Review
your imports from ``zope.app.component`` to see whether they cannot
come directly from ``zope.site`` instead.

zope.app.security -> zope.security
----------------------------------

The implementation of the ``<module>`` ZCML directive moved from this
package to ``zope.security``. Packages that relied on
``zope.app.security`` to obtain this directive should declare a direct
dependency on ``zope.security``, and it may be possible to lose the
dependency on ``zope.app.security`` altogether.


The ``protectclass`` module in this package has moved to
``zope.security``, with backwards compatibility imports left in
place. Review your imports from ``zope.app.security`` to see whether
they cannot come directly from ``zope.security`` instead.

zope.app.folder -> zope.site, zope.container
--------------------------------------------

The implementation of the ``zope.app.folder.Folder`` class has moved
to ``zope.site.folder`` instead, with backwards compatibility imports
left in place. Review your imports from ``zope.app.folder`` to see
whether they cannot come directly from ``zope.site`` instead. In
addition, ``Folder`` is an ``IContainer`` implementation that also
mixes in site management functionality. If such site management
support is not necessary, in some cases your code does not need
``Folder`` but may be able to rely on a ``Container`` implementation
from ``zope.container`` instead.

A base class with the implementation of the container-like behavior of
``Folder`` has moved to ``zope.container`` (and ``zope.site`` uses
this for its implementation of ``Folder``). This is not normally
something you should need to retain backwards compatibility.

zc.copy -> zope.copy, zope.copypastemove, zope.location
-------------------------------------------------------

The pluggable object copying mechanism once developed in the ``zc.copy``
package was merged back into ``zope.location``, ``zope.copypastemove``
and the new ``zope.copy`` package. The ``zope.copy`` package now provides
a pluggable mechanism for copying objects from ``zc.copy`` and doesn't
depend on anything but ``zope.interface``. The ``zope.copypastemove``
uses the ``copy`` function from ``zope.copy`` in its ``ObjectCopier``.

The ``zope.location`` now provides an ``ICopyHook`` adapter that implements
conditional copy functionality based on object locations, that old
``zope.location.pickling.CopyPersistent`` used to provide. Note, that if
you don't use ZCML configuration of ``zope.location``, you may need to
register ``zope.location.pickling.LocationCopyHook`` yourself.

The ``zope.location.pickling.locationCopy`` and
``zope.location.pickling.CopyPersistent`` are now deprecated in favor
of ``zope.copy`` and were replaced by deprecated imports. See
``zope.copy`` package documentation for information on how to use the
new mechanism.

The new version of the ``zc.copy`` package now only contains
backward-compatibility imports and is deprecated. ``zope.copy`` should
be preferred for new developments.

ZODB 3.9 FileStorage native blob support
----------------------------------------

The FileStorage component of ZODB 3.9 used in Zope Framework 3.5 now
supports blobs natively, so you don't need to use BlobStorage proxy
for it anymore.

Thus, you can specify blob directory directly to FileStorage. If you
use ZConfig, that means something like this::

  <filestorage>
    path var/Data.fs
    blob-dir var/blobs
  </filestorage>

instead of::

  <blobstorage>
    blob-dir var/blobs
    <filestorage>
      path var/Data.fs
    </filestorage>
  </blobstorage>

If you creating a storage from python, that means something like this:

.. code-block:: python

  storage = FileStorage('var/Data.fs', blob_dir='var/blobs')

instead of:

.. code-block:: python

  storage = BlobStorage('var/blobs', FileStorage('var/Data.fs'))
 