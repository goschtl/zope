#!/usr/bin/env python

"""Apply actions dictated by traffic_table.py to checkins as they occur.

An optional leading arg "--verbose" argument says operate verbosely.

We expect to be invoked from loginfo with "%{CVSROOT} %{sVv}".  The %{sVv}
format string causes the repository directory to be passed as an argument,
followed by an argument for each file, concatenated with the old and new
version numbers, like so: file-name,old-version,new-version.  (See the CVS
Gnu INFO file for the node 'loginfo' for more format-string details.)

Currently the actions are emailing checkin messages and doing an rsync 
to the public repository."""

VERBOSE = 1
SCRIPT = "postcommit_actions"           # Changes to args[0], when obtained.

import sys, os
import re, string

sVv_re = re.compile("(.*),([^,]+),([^,]+)")

def main(args):
    """Grok the args and the traffic_table and process accordingly."""

    global VERBOSE, SCRIPT

    if VERBOSE:
        print "Initial args:", args

    if (len(args) < 4
        or (args[1] == "--verbose" and (len(args) < 5))):
        usage(); raise SystemExit, 1

    # Identify all the args - see usage() for expected layout.
    SCRIPT = args[0]; del args[0]
    if args[0] == "--verbose":
        VERBOSE = 1
        del args[0]

    repo = args[0]; del args[0]
    subjs = map(grok_file, args)

    if VERBOSE:
        complain("CWD: %s, Repo: %s, ", os.getcwd(), repo)
        complain("Subjects: %s\n", subjs)

    got = find_entries(repo)
    for entry in got:
        (nm, expr, addrs, accts) = entry
        if addrs:
            do_notice(repo, addrs, subjs)
        if accts:
            do_sync(repo, accts, subjs)

    do_chmod(subjs)

def find_entries(repo):
    """Return all traffic_table entries that trigger for repo."""
    import traffic_table
    got = []
    for t in traffic_table.table:
        if re.search(t[1], repo):
            got.append(t)
    return got

def do_notice(repo, addrs, subjs):
    """Send notice about checkin."""
    if VERBOSE:
        fnames = string.join(map(lambda x: x[0], subjs), ",")
        complain("Notice to %s for %s / %s\n", addrs, repo, fnames)
def do_sync(repo, accts, subjs):
    """Instigate repository mirror synchronize."""
    if VERBOSE:
        fnames = string.join(map(lambda x: x[0], subjs), ",")
        complain("Sync for %s of %s/ %s / %s\n",
                 accts, os.environ["CVSROOT"], repo, fnames)

def do_chmod(subjs):
    fnames = map(lambda x: x[0], subjs)
    if VERBOSE:
        complain("Doing chmod on files: %s\n", fnames)
    os.system("echo chmod g+w %s" % string.join(fnames, " "))

def grok_file(s):
    """Separate "file,old-version,new-version"."""
    m = sVv_re.match(s)
    if not m:
        raise ValueError, "'%s' not in file,old-vers,new-vers format" % s
    return m.groups()

def usage():
    complain("Usage: %s repository-path file,oldv,newv f2,o2,n2 ...\n",
             SCRIPT)

def complain(msg, *args):
    sys.stderr.write(msg % args)

if __name__ == "__main__":
    main(sys.argv)

#echo postcommit_actions: '$0': $0, '$*': $*
#/usr/bin/rsync --verbose --archive --delete test dccvs@www.zope.org:
